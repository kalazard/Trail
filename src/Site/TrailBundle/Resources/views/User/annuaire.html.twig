{# empty Twig template #}
{% extends "SiteTrailBundle::layout.html.twig" %}

{% block title %}{{ parent() }} - Annuaire{% endblock %}

{% block body %}
	<div class="container">
		<h1>Annuaire</h1>
		<table class="table-striped table sieve">
			<thead>
				<tr>
					<th>Id</th>
					<th>Email</th>
					<th>Role</th>
						{% if app.user %}
							{% if is_granted('ROLE_Administrateur') %}
							<th>Editer</th>
							<th>Supprimer</th>
							{% endif %}
						{% endif %}
				</tr>
			</thead> 
			<tbody id="table_user">

			</tbody>
		</table>
	</div>
	
	
	
    <div class="modal fade" id="edit" tabindex="-1" role="dialog" aria-labelledby="edit" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-hidden="true"><span class="glyphicon glyphicon-remove" aria-hidden="true"></span></button>
                    <h4 class="modal-title custom_align" id="Heading">Modifier l'utilisateur</h4>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label>Email:</label>
                        <input id="emailUpdate" class="form-control" type="text" placeholder="Email">
                    </div>
                    <div class="form-group">
                        <label>Mot de passe:</label>
                        <input id="passwordUpdate" class="form-control " type="password" placeholder="Mot de passe">
                    </div>
                    <div class="form-group">
                        <label>Ressaisir le mot de passe:</label>
                        <input id="reenterPasswordUpdate" class="form-control " type="password" placeholder="Mot de passe">
                    </div>
                    <div class="form-group">
                        <label>Role:</label>
                        <select id="selectRoleEdit" class="form-control" name="selectRoleEdit" class="input-large"></select>
                    </div>        
                </div>
                <div class="modal-footer ">
                    <button id="btn_update" type="button" class="btn btn-warning btn-lg" style="width: 100%;"><span class="glyphicon glyphicon-ok-sign"></span> Update</button>
                </div>
            </div>
            <!-- /.modal-content --> 
        </div>
        <!-- /.modal-dialog --> 
    </div>

    <script>
        $(document).ready(function () {
            var table_user = $("#table_user");  //Tableau contenant les utilisateurs 
            var emailUpdate = $("#emailUpdate"); //Champ de mise à jour de l'email
            var passwordUpdate = $("#passwordUpdate");   //Champ de mise à jour du mot de passe
            var reenterPasswordUpdate = $("#reenterPasswordUpdate"); //Champ de mise a jour de la resaisis du mot de passe
            var roleUpdate = $("#selectRoleEdit");   //Combobox de mise à jour du role d'un utilisateur
            var btn_update = $("#btn_update");   //bouton qui déclenche la mise à jour d'un utilisateur
            fill_table_user();
            $("table.sieve").sieve();

            //Fonction permettant de remplir l'annuaire
            function fill_table_user()
            {
                table_user.empty();
                $.ajax({
                    type: "POST",
                    url: "{{path('site_trail_getAllUsers')}}",
                    data: {},
                    cache: false,
                    success: function (data) {
                        if (!data.serverError)
                        {
                            if (data.success)
                            {
                                table_user.empty();
                                var rows = "";
                                $.each(data.users, function (index, value) {
                                    rows = rows + "<tr><td>" + value.id + "</td><td>" + value.email + "</td><td>" + value.role + "</td><td><p data-placement='top' data-toggle='tooltip' title='Edit'><button class='btn btn-primary btn-xs btn_edit' data-title='Editer' data-value='" + value.id + "' data-toggle='modal' data-target='#edit' ><span class='glyphicon glyphicon-pencil'></span></button></p></td><td><p data-placement='top' data-toggle='tooltip' title='Delete'><button class='btn btn-danger btn-xs delete' data-value='" + value.id + "'><span class='glyphicon glyphicon-trash'></span></button></p></td</tr>"
                                });
                                table_user.append(rows);
                            }
                            else
                            {
                                table_user.empty();
                                $.notify("Vous ne pouvez pas voir le contenu de cette page", "error");

                            }
                        }
                        else
                        {
                            console.log(data.message);
                        }

                    }
                });
            }

            //Fonction permettant de mettre à jour un utilisateur dans la base de données
            var user = null;
            $(document).on('click', '.btn_edit', function () {
                var user_to_get = $(this).data('value');
                $.ajax({
                    type: "POST",
                    url: "{{ path('site_trail_getUser') }}",
                    data: {id_user: user_to_get},
                    cache: false,
                    success: function (data) {
                        if (!data.serverError)
                        {
                            if (data.success)
                            {
                                user = data.user;
                                emailUpdate.val(user.email);
                                console.log(data.role);
                                roleUpdate.val(data.role.id);

                            }
                            else
                            {
                                //Soit l'utilisateur n'existe plus dans la base de données
                                //Soit l'utilisateur n'a pas les droits necessaire pour supprimer un utilisateur
                                $.notify(data.message, "error");
                                fill_table_user();
                            }
                        }
                        else
                        {
                            console.log(data.message);
                        }

                    }
                });

            });

            //Gestion de la suppression d'un utilisateur
            $(document).on('click', '.delete', function () {

                if (confirm("Voulez vous vraiment supprimer cet utilisateur ?"))
                {
                    var user_to_delete = $(this).data('value');
                    $.ajax({
                        type: "POST",
                        url: "{{ path('site_trail_deleteUser') }}",
                        data: {id_user: user_to_delete},
                        cache: false,
                        success: function (data) {
                            if (!data.serverError)
                            {
                                if (data.success)
                                {
                                    $.notify(data.message, "success");
                                    //On recharge la liste des utilisateurs
                                    fill_table_user();
                                }
                                else
                                {
                                    //Soit l'utilisateur n'existe plus dans la base de données
                                    //Soit l'utilisateur n'a pas les droits necessaire pour supprimer un utilisateur
                                    $.notify(data.message, "error");
                                    fill_table_user();
                                }
                            }
                            else
                            {
                                console.log(data.message);
                            }

                        }
                    });
                }
                else
                {
                    //L'utilisateur ne souhaite pas supprimer l'utilisateur donc on ne change rien
                }

            });
            function load_combobox_roles(combobox)
            {
                $.ajax({
                    type: "POST",
                    url: "{{ path('site_trail_loadRoles') }}",
                    data: {},
                    cache: false,
                    success: function (data) {
                        if (data.success)
                        {
                            combobox.empty();

                            $.each(data.roles, function (index, value) {
                                combobox.append('<option value="' + value.id + '">' + value.name + '</option>');
                            });
                        }
                        else
                        {
                            combobox.empty();
                        }
                    }
                });
            }

            load_combobox_roles($("#selectRoleEdit"));

            //Quand on veut mettre à jour l'utilisateur
            btn_update.click(function () {
                var data = {id_user: user.id, emailUpdate: emailUpdate.val(), roleUpdate: roleUpdate.val()};
                if (passwordUpdate.val() != reenterPasswordUpdate.val())
                {
                    $.notify("Les mots de passe doivent être identiques", "error");
                    return false;
                }
                if (passwordUpdate.val() != "")
                {
                    data = {id_user: user.id, emailUpdate: emailUpdate.val(), passwordUpdate: passwordUpdate.val(), roleUpdate: roleUpdate.val()};
                }
                $.ajax({
                    type: "POST",
                    url: "{{ path('site_trail_updateUser') }}",
                    data: data,
                    cache: false,
                    success: function (data) {
                        if (!data.serverError)
                        {
                            if (data.success)
                            {
                                $.notify(data.message, "success");
                                fill_table_user();
                            }
                            else
                            {
                                //Soit des informations sont manquantes en base de données, soit des informations ne sont pas valide
                                $.notify(data.message, "error");
                                fill_table_user();
                            }
                        }
                        else
                        {
                            console.log(data.message)
                        }

                    }
                });

            });

        });
    </script>
{% endblock %}