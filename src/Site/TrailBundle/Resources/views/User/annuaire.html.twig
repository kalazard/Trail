{# empty Twig template #}
{% extends "SiteTrailBundle::layout.html.twig" %}

{% block title %}{{ parent() }} - Annuaire{% endblock %}

{% block body %}
  <table class="table-bordered table-striped table">
 <thead>
  <tr>
     <th>Id</th>
     <th>Email</th>
     <th>Role</th>
     {% if app.user %}
        {% if is_granted('ROLE_Administrateur') %}
             <th>Editer</th>
             <th>Supprimer</th>
        {% endif %}
    {% endif %}
  </tr>
 </thead> 
 <tbody id="table_user">
    
 </tbody>
</table>
  <div class="modal fade" id="edit" tabindex="-1" role="dialog" aria-labelledby="edit" aria-hidden="true">
      <div class="modal-dialog">
    <div class="modal-content">
          <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true"><span class="glyphicon glyphicon-remove" aria-hidden="true"></span></button>
        <h4 class="modal-title custom_align" id="Heading">Modifier l'utilisateur</h4>
      </div>
          <div class="modal-body">
          <div class="form-group">
              <label>Email:</label>
        <input id="emailUpdate" class="form-control" type="text" placeholder="Email">
        </div>
              <div class="form-group">
              <label>Mot de passe:</label>
        <input id="passwordUpdate" class="form-control " type="password" placeholder="Mot de passe">
        </div>
              <div class="form-group">
              <label>Ressaisir le mot de passe:</label>
        <input id="emailUpdate" class="form-control " type="password" placeholder="Mot de passe">
        </div>
        <div class="form-group">
        <label>Role:</label>
        <select id="selectRoleEdit" class="form-control" name="selectRoleEdit" class="input-large"></select>
        </div>        
      </div>
          <div class="modal-footer ">
        <button id="btn_update" type="button" class="btn btn-warning btn-lg" style="width: 100%;"><span class="glyphicon glyphicon-ok-sign"></span> Update</button>
      </div>
        </div>
    <!-- /.modal-content --> 
  </div>
      <!-- /.modal-dialog --> 
    </div>

    <script>
$(document).ready(function() {
   var table_user = $("#table_user");  //Tableau contenant les utilisateurs 
   var emailUpdate = $("#emailUpdate");
   var passwordUpdate = $("#passwordUpdate");
   var roleUpdate = $("#selectRoleEdit");
   var btn_update = $("#btn_update");
   fill_table_user();
   
   function fill_table_user()
   {
       table_user.empty();
       $.ajax({
        type: "POST",
        url: "{{path('site_trail_getAllUsers')}}",
        data: {},
        cache: false,
        success: function(data){           
           if(data.success)
           {               
               table_user.empty();
               var rows="";
               $.each(data.users, function(index, value) {                
                   rows = rows + "<tr><td>"+value.id+"</td><td>"+value.email+"</td><td>"+value.role+"</td><td><p data-placement='top' data-toggle='tooltip' title='Edit'><button class='btn btn-primary btn-xs btn_edit' data-title='Editer' data-value='"+value.id+"' data-toggle='modal' data-target='#edit' ><span class='glyphicon glyphicon-pencil'></span></button></p></td><td><p data-placement='top' data-toggle='tooltip' title='Delete'><button class='btn btn-danger btn-xs delete' data-value='"+value.id+"'><span class='glyphicon glyphicon-trash'></span></button></p></td</tr>"
               });
               table_user.append(rows);
           }
           else
           {
              table_user.empty();
              $.notify("Il y a eu une erreur", "error");
           }         
        
        }
    });
   }
   var user = null;
   $(document).on('click','.btn_edit', function() {
       var user_to_get = $(this).data('value');
       $.ajax({
        type: "POST",
        url: "{{ path('site_trail_getUser') }}",
        data: {id_user: user_to_get},
        cache: false,
        success: function(data){           
           if(data.success)
           {               
               user = data.user;
               emailUpdate.val(user.email);
               console.log(data.role);
               roleUpdate.val(data.role.id);               
           }   
           else
           {
             //L'utilisateur n'a pas les droits
           }
        }
    });
        
   });
   $(document).on('click','.delete', function() {
       var user_to_delete = $(this).data('value');
       $.ajax({
        type: "POST",
        url: "{{ path('site_trail_deleteUser') }}",
        data: {id_user: user_to_delete},
        cache: false,
        success: function(data){           
           if(data.success)
           {               
             $.notify("L'utilisateur a été supprimé", "success");
             fill_table_user();
           }   
           else
           {
             $.notify("Il y a eu un soucis", "error");  
           }
        }
    });
        
   });
   function load_combobox_roles(combobox)
{
    $.ajax({
        type: "POST",
        url: "{{ path('site_trail_loadRoles') }}",
        data: {},
        cache: false,
        success: function(data){           
           if(data.success)
           {               
              combobox.empty();
              
              $.each(data.roles, function(index, value) {                
                 combobox.append('<option value="'+ value.id +'">'+ value.name +'</option>');
               });
           }   
           else
           {
               combobox.empty();
           }
        }
    }); 
}

load_combobox_roles($("#selectRoleEdit"));

btn_update.click(function(){
    var data = {id_user:user.id, emailUpdate: emailUpdate.val(), roleUpdate: roleUpdate.val()};
    if(passwordUpdate.val() != "")
    {
        data = {id_user:user.id, emailUpdate: emailUpdate.val(), passwordUpdate: passwordUpdate.val(), roleUpdate: roleUpdate.val()};
    }
    $.ajax({
        type: "POST",
        url: "{{ path('site_trail_updateUser') }}",
        data: data,
        cache: false,
        success: function(data){           
           if(data.success)
           {               
              $.notify("L'utilisateur a été mis à jour", "success");
              fill_table_user();
           }   
           else
           {
               combobox.empty();
           }
        }
    });
    
});

});
    </script>
{% endblock %}